#!/usr/bin/env node

var hoodiecrow = require("../lib/server"),
    packageData = require("../package"),
    fs = require("fs"),
    argv = require('optimist').argv,
    simplesmtp = require("simplesmtp"),

    configLocation = argv.config || process.env.HOODIECROW_CONFIG,
    storageLocation = argv.storage || process.env.HOODIECROW_STORAGE,
    port = argv.port || argv.p || process.env.HOODIECROW_PORT,

    smtpPort = argv.smtpPort || process.env.HOODIECROW_SMTPPORT,

    pluginsList = [].concat.apply([], [].concat(argv.plugin || process.env.HOODIECROW_PLUGINS || []).map(function(plugin){
        return (plugin || "").toUpperCase().trim().split(/\s*,\s*/)
    })),

    secure = (argv.secure || argv.s || process.env.HOODIECROW_SECURE || "").toString().trim().toLowerCase() == "true",

    debug = (argv.debug || argv.d || process.env.HOODIECROW_DEBUG || "").toString().trim().toLowerCase() == "true",

    config = {};

if(configLocation){
    config = JSON.parse(fs.readFileSync(configLocation, "utf-8"));
}

if(storageLocation){
    config.storage = JSON.parse(fs.readFileSync(storageLocation, "utf-8"));
}

if(pluginsList && pluginsList.length){
    config.plugins = pluginsList;
}

if(secure){
    config.secureConnection = true;
}

if(debug){
    config.debug = true;
}

port = port || config.port;

if(!port){
    if(secure){
        port = 993;
    }else{
        port = 143;
    }
}

if(argv.h || argv.help){

    var help = fs.readFileSync(__dirname + "/help.txt", "utf-8"),
        list = fs.readdirSync(__dirname + "/../lib/plugins", "utf-8"),
        plugins = [],
        maxKey = 0,
        pluginText = [];

    list.forEach(function(plugin){
        var match, text = [], file;

        file = fs.readFileSync(__dirname + "/../lib/plugins/" + plugin, "utf-8");

        plugin = plugin.replace(/\.js$/gi, "").toUpperCase();

        file.replace(/@help (.*)/gim, function(o, help){
            text.push(help);
        });

        if(plugin.length > maxKey){
            maxKey = plugin.length;
        }

        plugins.push({key: plugin, value: text});
    });

    plugins.forEach(function(plugin){
        var indent = maxKey + 2;
        pluginText.push(" " + plugin.key + (new Array(indent - plugin.key.length).join(" "))+ (plugin.value && plugin.value[0] || ""));
        if(plugin.value){
            for(var j = 1; j<plugin.value.length; j++){
                pluginText.push((new Array(indent + 1).join(" "))+ plugin.value[j]);
            }
        }
    });

    console.log(help.
        replace(/__PLUGINS__/g, pluginText.join("\n")).
        replace(/__VERSION__/g, packageData.version).
        replace(/__VBAR__/g, new Array(packageData.version.length + 1).join("=")).
        trim()
        );

}else{
    var server = hoodiecrow(config);
    console.log("Starting Hoodiecrow ...");
    server.listen(port, function(){
        console.log("Hoodiecrow successfully%s listening on port %s", secure ? " and securely" : "", port);
    });

    if(smtpPort){
        simplesmtp.createSimpleServer({SMTPBanner:"Hoodiecrow"}, function(req){
            var data = [], dataLen = 0;
            req.on("data", function(chunk){
                if(!chunk || !chunk.length){
                    return;
                }
                data.push(chunk);
                dataLen += chunk.length;
            });
            req.on("end", function(){
              function handleDotEscaping(message) {
                // According to http://tools.ietf.org/html/rfc5321#section-4.5.2, 
                // SMTP clients are to escape any period appearing as the first
                // character of a line with another period.  This code removes
                // any of these inserted periods as they would appear as a doubled
                // period in email if we didn't.
                //
                // This should probably be considered an issue in simpleSMTP
                // since period escaping is part of the SMTP spec, but it doesn't
                // seem to be possible to fix it there with this API unless emitted 
                // chunks coincide with lines submitted by the SMTP client.  It
                // wasn't immediately clear whether that is the case.
                // And simpleSMTP is clearly labelled as deprecated anyway.  Might
                // as well hack in a fix here unless hoodiecrow were to move to
                // simpleSMTP's replacement
                //
                var dotsNotHandled = message.toString('utf-8');
                // If the message begins with a dot, we need to delete it, unless its part of a message terminator.
                var firstLineHandled = dotsNotHandled[0] === '.' && !(dotsNotHandled[1] === '\r' && dotsNotHandled[2] === '\n') ?
                                         dotsNotHanlded.substr(1) : dotsNotHandled;
                // This split/join deletes all periods that appear as the first character of a line
                // except for when it is immediately followed by <cr><lf> and thus is part of a message terminator.
                var textSurroundingFirstCharacterDots = dotsNotHandled.split('\r\n.');
                var intermediate = textSurroundingFirstCharacterDots.map(function(lineFollowingStartingDot) {
                  if (lineFollowingStartingDot.indexOf('\r\n') === 0) {
                    return '\r\n.' + lineFollowingStartingDot;
                  } else {
                    return lineFollowingStartingDot;
                  }
                });
                return new Buffer(intermediate.join('\r\n'));
              }

                var message = Buffer.concat(data, dataLen),
                  messageAfterHandlingDotEscaping = handleDotEscaping(message);
                server.appendMessage("INBOX", [], false, messageAfterHandlingDotEscaping.toString("binary"));
            });
            req.accept();
        }).listen(smtpPort, function(){
            console.log("Incoming SMTP server up and running on port %s", smtpPort);
        });
    }
}

